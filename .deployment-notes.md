# Deployment Notes for RoboEvalGradio Hugging Face Space

## Current Status
✅ All dependencies installing successfully
✅ GPU detected (Tesla T4, 15.83 GB)
✅ OpenPI, RoboEval, and lerobot all working
✅ Checkpoint uploaded to HF Hub: tan7271/pi0_CubeHandover_ckpt

## Architecture

### File Structure
- `requirements.txt` - Core PyPI dependencies
- `setup.sh` - Installation script for git dependencies
- `app.py` - Main Gradio application (clean, no installation logic)
- `start.py` - Alternative startup wrapper (optional)
- `upload_checkpoint.py` - Script to upload checkpoints to HF Hub

### Installation Flow
1. HF Spaces installs `requirements.txt` (PyPI packages)
2. `app.py` starts and calls `check_and_install_dependencies()`
3. If needed, runs `setup.sh` to install git dependencies:
   - RoboEval (with submodules)
   - lerobot (specific commit)
   - safetensors upgrade
   - OpenPI + openpi-client

### Key Dependencies
- **RoboEval**: Installed from git with `--recurse-submodules` to include `thirdparty/mujoco_menagerie`
- **lerobot**: Installed from specific commit `0cf864870cf29f4738d3ade893e6fd13fbd7cdb5`
- **OpenPI**: Installed with `--no-deps` (dependencies in requirements.txt)
- **openpi-client**: Installed from subdirectory `packages/openpi-client`

## Environment Variables
- `GH_TOKEN`: GitHub personal access token for private repo access
- `MUJOCO_GL=egl`: Headless rendering
- `PYOPENGL_PLATFORM=egl`: OpenGL backend
- `XDG_RUNTIME_DIR=/tmp`: Runtime directory

## Hardware Requirements
- **Minimum**: T4 small GPU (16GB) - ~$0.60/hour
- **Recommended**: L4 or A10G for better performance
- **Free tier**: Won't work (insufficient memory for Pi0 models)

## Checkpoint Usage
Users can provide checkpoints in three formats:
1. **Hugging Face Hub**: `tan7271/pi0_CubeHandover_ckpt` or `hf://tan7271/...`
2. **Google Cloud Storage**: `gs://bucket/path/to/checkpoint`
3. **Local path**: `/path/to/checkpoint` (must exist on Space filesystem)

The app automatically detects HF Hub paths and downloads them using `snapshot_download`.

## Known Issues Fixed
1. ✅ `beartype` missing - Added to requirements.txt
2. ✅ `safetensors` version conflict - Upgraded after lerobot install
3. ✅ `lerobot.common` missing - Install from specific git commit
4. ✅ `openpi_client` missing - Install from subdirectory
5. ✅ `thirdparty/mujoco_menagerie` missing - Copy after RoboEval install
6. ✅ Dependency resolution errors - Simplified requirements.txt
7. ✅ PyPI version conflicts - Use exact working versions

## Troubleshooting

### If dependencies fail to install:
- Check GH_TOKEN is set in Space secrets
- Check setup.sh has execution permissions
- Review build logs for specific errors

### If GPU not detected:
- Verify Space is using T4 small or better in Settings
- Check logs for "GPU DIAGNOSTICS" section
- Ensure CUDA drivers are loading

### If out of memory:
- Model might be too large for T4
- Try reducing max_steps parameter
- Consider using model quantization
- Upgrade to larger GPU (L4, A10G)

## Next Steps
- Monitor build logs after deployment
- Test inference with uploaded checkpoint
- Add more checkpoints for other tasks
- Consider adding model caching to speed up subsequent loads

